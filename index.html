<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
	<title>サポートシステム</title>
	<link rel="stylesheet" href="./index.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
	<script>
		var ws;
		var student;
		var handupStudentList;
		var maxWaitingTime=0;
		fetch('/Support/connect-websocket')
			.then(response => response.text())
			.then(data => {
				//ws = new WebSocket("ws://localhost/Support/websocket/_administrator");
				//        const ws = new WebSocket("ws://localhost/Support/websocket/teacher);-->
				ws = new WebSocket("ws://localhost/Support/websocket");
				ws.onopen = () => {
					//    		ws.send('Hello from JavaScript client!');
					//            console.log("WebSocket connection opened.");
					setDialogClick();
					showDialogUp();

				};
				
				// メッセージを受信したときに呼び出される
				ws.onmessage = function (event) {
					const obj = JSON.parse(event.data);
					student = obj.clientStudent;
					handupStudentList = obj.handupStudentList;
					
					maxWaitingTime = getMaxWaitingTime(handupStudentList);
					setStudentInfo(student);
					
					if(student.helpStatus=="None"){
						showDialogUp();
					}else{
						showDialogDown();
					}
					console.log('Message received from server: ' + event.data);
				};

				// エラーが発生したときに呼び出される
				ws.onerror = function (error) {
					alert("Error");
					console.error('WebSocket error: ' + error);
				};

				// 接続が閉じられたときに呼び出される
				ws.onclose = function (event) {
					console.log('WebSocket connection closed');
				};
			});


		//-------------------
		// 待ち時間の更新
		//-------------------
		const intervalId = setInterval(() => {
			waitingtimeUpdate();
			//        clearInterval(intervalId); // インターバルをクリア
		}, 1000);

		function waitingtimeUpdate() {
			maxWaitingTime++;
			if (student != null && student.helpStatus == "Troubled") {
				student.waitingTimeBySecond++;
				setStudentInfoTime(student);
				setStudentInfoTimebar(student);
				updateChart();
			}
			for (var i = 0; i < handupStudentList.length; i++) {
				if (handupStudentList[i].helpStatus == "Troubled") {
					handupStudentList[i].waitingTimeBySecond++;
				}
			}
		}
		
		function getMaxWaitingTime(handupStudentList){
			var max=0;
			if(handupStudentList != null){
			for(var i=0; i<handupStudentList.length; i++){
				if( max < handupStudentList[i].waitingTimeBySecond){
					max=handupStudentList[i].waitingTimeBySecond;
				}
			}
			}
			return max;
		}

		//-------------------
		// クリック時の動作設定
		//-------------------
		function setDialogClick(){
			document.getElementById("dialog-up").addEventListener('click', (event) => {
			    ws.send("Troubled");
				showDialogDown();
			});
			document.getElementById("dialog-down").addEventListener('click', (event) => {
			    ws.send("None");
				showDialogUp();
			});
		}
		
		function showDialogUp(){
			document.getElementById("dialog-up").style.display="block";
			document.getElementById("dialog-down").style.display="none";
		}

		function showDialogDown(){
			document.getElementById("dialog-up").style.display="none";
			document.getElementById("dialog-down").style.display="block";
		}
		
		//-------------------
		// 学生情報の表示設定
		//-------------------
		function setStudentInfo(student) {
			document.getElementById("pcname").innerText = student.pcId;
			document.getElementById("status").style.display = "none";
			setStudentInfoStatus(student);
			setStudentInfoPriority(student);
			setStudentInfoTimebar(student);
			setStudentInfoTime(student);
		}

		function setStudentInfoStatus(student){
			var color="white";
			if(student.helpStatus=="None"){
				color="white";
			}else if(student.helpStatus=="Troubled"){
				color="yellow";
			}else if(student.helpStatus=="Supporting"){
				color="lightgreen";
			}
			document.getElementById("student").style.backgroundColor=color;
		}

		function setStudentInfoPriority(student){
			document.getElementById("priority").innerText = student.handPriority;
			if(student.handPriority == "999"){
				document.getElementById("priority").style.display = "none";				
			}else{
				document.getElementById("priority").style.display = "block";	
			}
		}
		
		function setStudentInfoTime(student){
			const time = student.waitingTimeBySecond;
			const hour = Math.floor(time / 3600);
			const minute = Math.floor((time - hour * 3600) / 60);
			const second = time - hour * 3600 - minute * 60;
			
			document.getElementById("time").innerText = getDisplayTime(hour,minute,second);
		}
		
		function getDisplayTime(hour,minute,second){
			if(hour==0 && minute ==0 ){
				return second+" 秒";
			}else if(hour==0 && minute >0){
				return minute+" 分 "+second+" 秒";
			}else if(hour>0){
				return hour+" 時 "+minute+" 分 "+second+" 秒";
			}
		}

		function setStudentInfoTimebar(student){
			const time = student.waitingTimeBySecond;

			var maxBarLength=120;

			var color="white";
			if(maxWaitingTime <60){
				timeBarLength=Math.floor(time/60*maxBarLength);
				color="blue";
			}else if(maxWaitingTime <300){
				timeBarLength=Math.floor(time/300*maxBarLength);
				color="red";
			}else if(maxWaitingTime <600){
				timeBarLength=Math.floor(time/600*maxBarLength);
				color="black";
			}else{
				timeBarLength=maxBarLength;
				color="black";
			}
			if(student.helpStatus=="Troubled"){
				document.getElementById("timebar").style.display="block";
				document.getElementById("timebar").style.width = timeBarLength+"px";
				document.getElementById("timebar").style.background = color;
			}else{
				document.getElementById("timebar").style.display="none";
			}
		}

	</script>

	</head>
	<body>
		<div id="dialog-up">手を挙げる</div>
		<div id="dialog-down">手を下ろす</div>

		<div id="student" class="student">
			<div id="pcname" class="pcname"></div>
			<div id="status" class="status"></div>
			<div id="priority" class="prioroty"></div>
			<div id="timebar" class="timebar"></div>
			<div id="time" class="time"></div>
		</div>
		<div id="chart">
			<canvas id="waiting_list_chart"></canvas>
		</div>

	</body>
	
	<style>
	#waiting_list_chart {max-width:300px;max-height:500px;}
	</style>

	<script>
		function updateChart(){
			var maxValue=120;

			if(maxWaitingTime <60){
				maxValue = 60;
			}else if(maxWaitingTime <300){
				maxValue = 300;
			}else if(maxWaitingTime <600){
				maxValue=600;
			}else{
				maxValue=600;
			}

		var labelList=[];
		var dataList=[];
		if(handupStudentList != null){
			for(var i=0; i<handupStudentList.length; i++){
				labelList.push(""+(i+1));
				dataList.push(""+handupStudentList[i].waitingTimeBySecond);			
			}
		}

		var ctx = document.getElementById('waiting_list_chart');

		var data = {
    		labels: labelList,
    		datasets: [{
        		label: '待ち時間',
        		data: dataList,
        		backgroundColor: 'rgba(255, 100, 100, 1)'
    		}]
		};

		var capacity_options = {
	    	indexAxis: 'y',
	    	scales: {
	        	x:{
	            	min: 0,
	            	max: maxValue
	        	}
	    	}
		};

		var waiting_list_chart = new Chart(ctx, {
	    	type: 'bar',
	    	data: data,
	    	options: capacity_options
		});
			
		}
		
</script>

</html>